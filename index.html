<!doctype html>
<html>
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>WebXR Minimal</title>
   <script src="https://unpkg.com/three@0.150.0/build/three.js"></script>
</head>
<body>
   <button id="start">Start AR</button>
   <script>
      document.getElementById("start").addEventListener("click", async () => {
         if (!navigator.xr) {
            alert("WebXR not supported.");
            return;
         }

         try {
            const session = await navigator.xr.requestSession("immersive-ar");
            const canvas = document.createElement("canvas");
            document.body.appendChild(canvas);
            const gl = canvas.getContext("webgl", { xrCompatible: true });
            const renderer = new THREE.WebGLRenderer({ canvas, context: gl });
            renderer.autoClear = false;

            const scene = new THREE.Scene();
            const cube = new THREE.Mesh(
               new THREE.BoxGeometry(0.3, 0.3, 0.3),
               new THREE.MeshBasicMaterial({ color: 0xff0000 })
            );
            cube.position.set(0, 0, -1);
            scene.add(cube);

            const camera = new THREE.PerspectiveCamera();
            const refSpace = await session.requestReferenceSpace("local");
            session.updateRenderState({ baseLayer: new XRWebGLLayer(session, gl) });

            const renderFrame = (time, frame) => {
               const pose = frame.getViewerPose(refSpace);
               if (pose) {
                  const view = pose.views[0];
                  const viewport = session.renderState.baseLayer.getViewport(view);
                  renderer.setSize(viewport.width, viewport.height);
                  gl.viewport(viewport.x, viewport.y, viewport.width, viewport.height);

                  camera.matrix.fromArray(view.transform.matrix);
                  camera.projectionMatrix.fromArray(view.projectionMatrix);
                  camera.updateMatrixWorld(true);

                  renderer.render(scene, camera);
               }
               session.requestAnimationFrame(renderFrame);
            };
            session.requestAnimationFrame(renderFrame);
         } catch (err) {
            console.error("Error starting AR session:", err);
         }
      });
   </script>
</body>
</html>
